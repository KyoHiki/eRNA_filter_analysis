```r
########## Read packages ##########
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(ComplexHeatmap)
library(ggprism)
library(GGally)
library(ggplotify)
library(cowplot)
library(readxl)
library(svglite)

library(Rsubread)
library(edgeR)



########## Read count data ##########
## count data were generated by HTSeq
HTSeq <- read.csv("htseq_all_sample_count_filter.tsv",sep="\t",header=TRUE,row.names=1,stringsAsFactors=F) %>% 
    dplyr::rename(Filter_3_1="X0_eRNA", Filter_3_2="X1_eRNA", Filter_3_3="X2_eRNA", Filter_3_4="X3_eRNA",
                  Filter_04_1="X4_eRNA", Filter_04_2="X5_eRNA", Filter_04_3="X6_eRNA", Filter_04_4="X7_eRNA",
                  Filter_10_1="X8_eRNA", Filter_10_2="X9_eRNA", Filter_10_3="X10_eRNA", Filter_10_4="X11_eRNA",
                  Skin_1="X12_eRNA", Skin_2="X13_eRNA", Skin_3="X14_eRNA", Skin_4="X15_eRNA" )  
tail(HTSeq)

HTSeq <- HTSeq[1:26664,] %>%
  dplyr::select(Filter_04_1,Filter_04_2,Filter_04_3,Filter_04_4,  Filter_3_1,Filter_3_2,Filter_3_3,Filter_3_4,    Filter_10_1,Filter_10_2,Filter_10_3,Filter_10_4,
                Skin_1,Skin_2,Skin_3,Skin_4)


########## Read TIN data ##########
## TIN: Transcript Integrity Number
TIN_raw <- read_xlsx("TIN_summary.xlsx",sheet="gene")   

TIN <- TIN_raw %>%
  mutate(Gene = (str_split_fixed(TIN_raw$geneID,";",n=3))[,3] ) %>%
  group_by(Gene) %>%
  summarize(Filter_3_1 = mean(TIN_0), Filter_3_2= mean(TIN_1), Filter_3_3 = mean(TIN_2), Filter_3_4= mean(TIN_3),
         Filter_04_1 = mean(TIN_4), Filter_04_2 = mean(TIN_5),Filter_04_3 = mean(TIN_6),Filter_04_4 = mean(TIN_7),
         Filter_10_1 = mean(TIN_8), Filter_10_2 = mean(TIN_9),Filter_10_3 = mean(TIN_10),Filter_10_4 = mean(TIN_11),
         Skin_1 = mean(TIN_12), Skin_2 = mean(TIN_13), Skin_3 = mean(TIN_14), Skin_4 = mean(TIN_15) ) %>%
  ungroup() %>% 
  rowwise() %>%
  mutate("3 µm" = mean(c(Filter_3_1,Filter_3_2,Filter_3_3,Filter_3_4)),
         "0.4 µm" = mean(c(Filter_04_1,Filter_04_2,Filter_04_3,Filter_04_4)),
         "10 µm" = mean(c(Filter_10_1,Filter_10_2,Filter_10_3,Filter_10_4)),
         Skin = mean(c(Skin_1,Skin_2,Skin_3,Skin_4)) )　
  
dim(TIN)
# [1] 44871    21    
```




```r
########## Estimation of the number of detected genes ##########
#### Filtering  ####
Type <-  c(c( rep("Filter small",4),rep("Filter middle",4),rep("Filter large",4) )) %>% as.factor()
Design <- model.matrix(~0+Type)

HTSeq_water <- HTSeq %>% 
  dplyr::select(Filter_04_1,Filter_04_2,Filter_04_3,Filter_04_4,  Filter_3_1,Filter_3_2,Filter_3_3,Filter_3_4,    Filter_10_1,Filter_10_2,Filter_10_3,Filter_10_4)


exp_res_water_04 <- DGEList(counts=HTSeq_water[,1:4], group=Type[1:4], genes=rownames(HTSeq_water))
exp_res_water_3 <- DGEList(counts=HTSeq_water[,5:8], group=Type[5:8], genes=rownames(HTSeq_water))
exp_res_water_10 <- DGEList(counts=HTSeq_water[,9:12], group=Type[9:12], genes=rownames(HTSeq_water))
exp_res_skin <- DGEList(counts=HTSeq[,13:16], group=rep("Skin",4), genes=rownames(HTSeq))
 

## for 0.4 µm filter
keep_04 <- rowSums(cpm(exp_res_water_04) > 10) >= 3    # Retrieve genes with > 10 counts in 3 or more libraries
table(keep_04)  
#note: Chen et al (2016, F1000) recommends that a gene should have a count of at least 10–15 in at least some libraries. 
#FALSE  TRUE 
#25692   972     
exp_res_filtered_04 <- exp_res_water_04[keep_04, , keep.lib.sizes=FALSE] 


## for 3 µm filter
keep_3 <- rowSums(cpm(exp_res_water_3) > 10) >= 3    # Retrieve genes with > 10 counts in 3 or more libraries
table(keep_3)  
#note: Chen et al (2016, F1000) recommends that a gene should have a count of at least 10–15 in at least some libraries. 
#FALSE  TRUE 
#21266  5398   
exp_res_filtered_3 <- exp_res_water_3[keep_3, , keep.lib.sizes=FALSE] 


## for 10 µm filter
keep_10 <- rowSums(cpm(exp_res_water_10) > 10) >= 3    # Retrieve genes with > 10 counts in 3 or more libraries
table(keep_10)  
#note: Chen et al (2016, F1000) recommends that a gene should have a count of at least 10–15 in at least some libraries. 
#FALSE  TRUE 
#21819  4845   
exp_res_filtered_10 <- exp_res_water_10[keep_10, , keep.lib.sizes=FALSE] 


## for skin RNA
keep_skin <- rowSums(cpm(exp_res_skin) > 10) >= 3     # Retrieve genes with > 10 counts in 3 or more libraries
table(keep_skin)  
#note: Chen et al (2016, F1000) recommends that a gene should have a count of at least 10–15 in at least some libraries. 
#FALSE  TRUE 
#17529  9135   
exp_res_filtered_skin <- exp_res_skin[keep_skin, , keep.lib.sizes=FALSE] 


#### Check the overlap of detected genes among sample types  ####
Gene_filter04 <- exp_res_filtered_04$genes[,1]
Gene_filter3 <- exp_res_filtered_3$genes[,1]
Gene_filter10 <- exp_res_filtered_10$genes[,1]
Gene_skin <- exp_res_filtered_skin$genes[,1]

Gene_all <- union(Gene_filter04,Gene_filter3)  %>% union(Gene_filter10) %>% union(Gene_skin) 
Skin_specific <- setdiff(Gene_skin, Gene_filter3) %>% setdiff(Gene_filter04) %>% setdiff(Gene_filter10)  # Genes specifically detected in skin RNA
Gene_skin_and_water <- setdiff(Gene_skin, Skin_specific)  # Genes detected in both skin RNA and eRNA

length(Gene_skin_and_water)
#[1] 5148
  
# write.csv(Gene_filter04,"Gene_filter04.csv")
# write.csv(Gene_filter3,"Gene_filter3.csv")
# write.csv(Gene_filter10,"Gene_filter10.csv")
# write.csv(Gene_skin,"Gene_skin.csv")
# write.csv(Gene_all,"Gene_all.csv")
# write.csv(Skin_specific,"Gene_skin_specific.csv")
# write.csv(Gene_skin_and_water,"Gene_skin_and_water.csv")
```








